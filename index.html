<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket API Tester</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        section { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        button { padding: 8px 12px; margin: 5px 0; cursor: pointer; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0 15px; box-sizing: border-box; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Ticket Reservation API Tester</h1>

    <!-- Sezione Autenticazione -->
    <section id="auth">
        <h2>Autenticazione</h2>

        <h3>Registrazione</h3>
        <input type="text" id="reg-username" placeholder="Username">
        <input type="email" id="reg-email" placeholder="Email">
        <input type="password" id="reg-password" placeholder="Password">
        <button onclick="register()">Registrati</button>
        <div id="register-result"></div>

        <h3>Login</h3>
        <input type="text" id="login-username" placeholder="Username">
        <input type="password" id="login-password" placeholder="Password">
        <button onclick="login()">Login</button>
        <div id="login-result"></div>
        <div id="token-display"></div>
    </section>

    <!-- Sezione Eventi -->
    <section id="events">
        <h2>Gestione Eventi</h2>
        <button onclick="getEvents()">Mostra Eventi</button>
        <div id="events-list"></div>

        <h3>Crea Evento (solo organizzatori)</h3>
        <input type="text" id="event-title" placeholder="Titolo">
        <textarea id="event-desc" placeholder="Descrizione"></textarea>
        <input type="datetime-local" id="event-date">
        <input type="text" id="event-location" placeholder="Luogo">
        <input type="number" id="event-seats" placeholder="Posti totali">
        <button onclick="createEvent()">Crea Evento</button>
        <div id="event-result"></div>
    </section>

    <!-- Sezione Prenotazioni -->
    <section id="reservations">
        <h2>Gestione Prenotazioni</h2>
        <button onclick="getMyReservations()">Mie Prenotazioni</button>
        <div id="reservations-list"></div>

        <h3>Crea Prenotazione</h3>
        <select id="event-select"></select>
        <input type="number" id="reservation-seats" placeholder="Numero posti">
        <button onclick="createReservation()">Prenota</button>
        <div id="reservation-result"></div>
    </section>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let authToken = null;

        // Funzioni di utilit√†
        function displayResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            element.className = isError ? 'error' : 'success';
        }

        async function makeRequest(url, method = 'GET', body = null, auth = true) {
            const headers = {
                'Content-Type': 'application/json'
            };

            if (auth && authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            try {
                const response = await fetch(url, {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : null
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || JSON.stringify(data));
                }

                return data;
            } catch (error) {
                console.error('Request failed:', error);
                throw error;
            }
        }

        // Funzioni Autenticazione
        async function register() {
            try {
                const user = {
                    username: document.getElementById('reg-username').value,
                    email: document.getElementById('reg-email').value,
                    password: document.getElementById('reg-password').value,
                    password2: document.getElementById('reg-password').value
                };

                const result = await makeRequest(
                    `${API_BASE}/auth/register/`,
                    'POST',
                    user,
                    false
                );

                displayResult('register-result', result);
            } catch (error) {
                displayResult('register-result', error.message, true);
            }
        }

        async function login() {
            try {
                const credentials = {
                    username: document.getElementById('login-username').value,
                    password: document.getElementById('login-password').value
                };

                const result = await makeRequest(
                    `${API_BASE}/auth/login/`,
                    'POST',
                    credentials,
                    false
                );

                authToken = result.access;
                document.getElementById('token-display').innerText = `Token: ${authToken.substring(0, 20)}...`;
                displayResult('login-result', {message: 'Login successful', user: result.user});

                // Carica gli eventi dopo il login
                await getEvents();
            } catch (error) {
                displayResult('login-result', error.message, true);
            }
        }

        // Funzioni Eventi
        async function getEvents() {
            try {
                const events = await makeRequest(`${API_BASE}/events/`);
                displayResult('events-list', events);

                // Popola il dropdown per le prenotazioni
                const select = document.getElementById('event-select');
                select.innerHTML = '';
                events.forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = `${event.title} (${event.available_seats} posti)`;
                    select.appendChild(option);
                });
            } catch (error) {
                displayResult('events-list', error.message, true);
            }
        }

        async function createEvent() {
            try {
                const event = {
                    title: document.getElementById('event-title').value,
                    description: document.getElementById('event-desc').value,
                    date: document.getElementById('event-date').value,
                    location: document.getElementById('event-location').value,
                    total_seats: document.getElementById('event-seats').value
                };

                const result = await makeRequest(
                    `${API_BASE}/events/`,
                    'POST',
                    event
                );

                displayResult('event-result', result);
                await getEvents(); // Refresh lista eventi
            } catch (error) {
                displayResult('event-result', error.message, true);
            }
        }

        // Funzioni Prenotazioni
        async function getMyReservations() {
            try {
                const reservations = await makeRequest(`${API_BASE}/reservations/my/`);
                displayResult('reservations-list', reservations);
            } catch (error) {
                displayResult('reservations-list', error.message, true);
            }
        }

        async function createReservation() {
            try {
                const select = document.getElementById('event-select');
                const eventId = select.options[select.selectedIndex].value;
                const seats = document.getElementById('reservation-seats').value;

                const reservation = {
                    event: eventId,
                    seats: seats
                };

                const result = await makeRequest(
                    `${API_BASE}/reservations/`,
                    'POST',
                    reservation
                );

                displayResult('reservation-result', result);
                await getEvents(); // Refresh lista eventi e posti disponibili
                await getMyReservations(); // Refresh lista prenotazioni
            } catch (error) {
                displayResult('reservation-result', error.message, true);
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            // Formatta la data minima per il campo datetime-local
            const now = new Date();
            const minDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            document.getElementById('event-date').min = minDate;
        });
    </script>
</body>
</html>